# Azure DevOps Pipeline for Karnataka Travel Planner
# Deploys infrastructure with Terraform and application with Azure Web App

trigger:
  - main

# Use Microsoft-hosted agents (free tier)
pool:
  vmImage: 'ubuntu-latest'

# Limit concurrent jobs to 1 to avoid parallelism issues
jobs:
- job: 'SetupAndDeploy'
  displayName: 'Setup Infrastructure and Deploy Application'
  steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.6.5'

  - task: AzureCLI@2
    displayName: 'Create Storage Account for Terraform State'
    inputs:
      azureSubscription: 'your-azure-subscription-name'  # Update this
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Create resource group if it doesn't exist
        az group create --name TravelPlanner --location "Central US" --output none

        # Create storage account for Terraform state
        STORAGE_ACCOUNT="tfstate$(Build.BuildId)"
        az storage account create \
          --name $STORAGE_ACCOUNT \
          --resource-group TravelPlanner \
          --location "Central US" \
          --sku Standard_LRS \
          --encryption-services blob \
          --output none

        # Create storage container
        az storage container create \
          --name tfstate \
          --account-name $STORAGE_ACCOUNT \
          --output none

        # Set environment variable for storage account name
        echo "##vso[task.setvariable variable=storageAccountName]$STORAGE_ACCOUNT"

  - task: TerraformTaskV3@3
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: 'deployment'
      backendServiceArm: 'your-azure-subscription-name'  # Update this
      backendAzureRmResourceGroupName: 'TravelPlanner'
      backendAzureRmStorageAccountName: $(storageAccountName)
      backendAzureRmContainerName: 'tfstate'
      backendAzureRmKey: 'terraform.tfstate'

  - task: TerraformTaskV3@3
    displayName: 'Terraform Validate'
    inputs:
      provider: 'azurerm'
      command: 'validate'
      workingDirectory: 'deployment'

  - task: TerraformTaskV3@3
    displayName: 'Terraform Plan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: 'your-azure-subscription-name'  # Update this

  - task: TerraformTaskV3@3
    displayName: 'Terraform Apply'
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: 'your-azure-subscription-name'  # Update this

  - task: AzureWebApp@1
    displayName: 'Deploy Azure Web App'
    inputs:
      azureSubscription: 'your-azure-subscription-name'  # Update this
      appType: 'webAppLinux'
      appName: 'vintekh'
      package: '$(System.DefaultWorkingDirectory)/**'
      deploymentMethod: 'auto'
- stage: 'SetupBackend'
  displayName: 'Setup Terraform Backend'
  jobs:
  - job: 'CreateStorage'
    displayName: 'Create Storage Account for Terraform State'
    steps:
    - task: AzureCLI@2
      displayName: 'Create Resource Group and Storage Account'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Create resource group if it doesn't exist
          az group create --name $(resourceGroupName) --location "$(location)" --output none

          # Create storage account for Terraform state
          az storage account create \
            --name $(storageAccountName) \
            --resource-group $(resourceGroupName) \
            --location "$(location)" \
            --sku Standard_LRS \
            --encryption-services blob \
            --output none

          # Create storage container
          az storage container create \
            --name tfstate \
            --account-name $(storageAccountName) \
            --output none

- stage: 'TerraformValidate'
  displayName: 'Terraform Validate'
  dependsOn: 'SetupBackend'
  jobs:
  - job: 'Validate'
    displayName: 'Validate Terraform Configuration'
    steps:
    - task: TerraformInstaller@0
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: $(terraformVersion)

    - task: TerraformTaskV3@3
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: $(workingDirectory)
        backendServiceArm: $(azureSubscription)
        backendAzureRmResourceGroupName: $(resourceGroupName)
        backendAzureRmStorageAccountName: $(storageAccountName)
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'

    - task: TerraformTaskV3@3
      displayName: 'Terraform Validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: $(workingDirectory)

    - task: TerraformTaskV3@3
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: $(workingDirectory)
        environmentServiceNameAzureRM: $(azureSubscription)

- stage: 'TerraformApply'
  displayName: 'Terraform Apply'
  dependsOn: 'TerraformValidate'
  condition: succeeded()
  jobs:
  - deployment: 'Apply'
    displayName: 'Apply Terraform Configuration'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: TerraformTaskV3@3
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(workingDirectory)
              backendServiceArm: $(azureSubscription)
              backendAzureRmResourceGroupName: $(resourceGroupName)
              backendAzureRmStorageAccountName: $(storageAccountName)
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'terraform.tfstate'

          - task: TerraformTaskV3@3
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: $(workingDirectory)
              environmentServiceNameAzureRM: $(azureSubscription)

- stage: 'DeployApplication'
  displayName: 'Deploy Application'
  dependsOn: 'TerraformApply'
  condition: succeeded()
  jobs:
  - deployment: 'Deploy'
    displayName: 'Deploy to Azure Web App'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: $(azureSubscription)
              appType: 'webAppLinux'
              appName: $(webAppName)
              package: '$(System.DefaultWorkingDirectory)/**'
              deploymentMethod: 'auto'