# Azure DevOps Pipeline for Karnataka Travel Planner
# Deploys infrastructure with Terraform and application with Azure Web App

# Disable CI trigger to avoid automatic runs
trigger: none

# Manual trigger only
pr: none

# Use Microsoft-hosted agents (free tier)
pool: seflhoster

variables:
  azureSubscription: 'Hub(64132586-e6cc-436d-b2dd-26d6a11df4f7)'  # Update this to match your service connection name

# Serial jobs: Infrastructure first, then Application
# NOTE: Jobs run serially due to dependsOn - no parallelism used
jobs:
- job: 'DeployInfrastructure'
  displayName: 'Deploy Infrastructure with Terraform'
  steps:
  - task: Bash@3
    displayName: 'Install unzip utility'
    inputs:
      targetType: 'inline'
      script: |
        sudo apt-get update
        sudo apt-get install -y unzip

  - task: TerraformInstaller@1
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.14.3'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: 'deployment'
      backendServiceArm: $(azureSubscription)
      backendAzureRmResourceGroupName: 'TerraformBackent'
      backendAzureRmStorageAccountName: 'vintekhtfbackend'
      backendAzureRmContainerName: 'tfstate'
      backendAzureRmKey: 'terraform.tfstate'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Validate'
    inputs:
      provider: 'azurerm'
      command: 'validate'
      workingDirectory: 'deployment'

  - task: TerraformTaskV4@4
    displayName: 'Terraform Plan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: $(azureSubscription)

  - task: TerraformTaskV4@4
    displayName: 'Terraform Apply'
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: $(azureSubscription)

- job: 'DeployApplication'
  displayName: 'Deploy Application to Azure Web App'
  dependsOn: 'DeployInfrastructure'
  steps:
  - task: CopyFiles@2
    displayName: 'Copy application files'
    inputs:
      SourceFolder: '$(System.DefaultWorkingDirectory)'
      Contents: |
        app.py
        requirements.txt
        startup.sh
        verify_deployment.py
        components/**
        data/**
        pages/**
        services/**
        utils/**
      TargetFolder: '$(Build.ArtifactStagingDirectory)/app'

  - task: Bash@3
    displayName: 'Install zip utility'
    inputs:
      targetType: 'inline'
      script: |
        sudo apt-get update
        sudo apt-get install -y zip

  - task: ArchiveFiles@2
    displayName: 'Create deployment package'
    inputs:
      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/app'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/deployment.zip'
      replaceExistingArchive: true

  - task: AzureWebApp@1
    displayName: 'Deploy Azure Web App'
    inputs:
      azureSubscription: $(azureSubscription)
      appType: 'webAppLinux'
      appName: 'vintekh'
      package: '$(Build.ArtifactStagingDirectory)/deployment.zip'
      deploymentMethod: 'auto'