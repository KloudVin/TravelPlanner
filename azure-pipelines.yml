# Azure DevOps Pipeline for Karnataka Travel Planner
# Deploys infrastructure with Terraform and application with Azure Web App

trigger:
  - main

# Use Microsoft-hosted agents (free tier)
pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'Hub(64132586-e6cc-436d-b2dd-26d6a11df4f7)'  # Update this to match your service connection name

# Limit concurrent jobs to 1 to avoid parallelism issues
jobs:
- job: 'SetupAndDeploy'
  displayName: 'Setup Infrastructure and Deploy Application'
  steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.6.5'

  - task: AzureCLI@2
    displayName: 'Create Storage Account for Terraform State'
    inputs:
      azureSubscription: $(azureSubscription)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Create resource group if it doesn't exist
        az group create --name TravelPlanner --location "Central US" --output none

        # Create storage account for Terraform state
        STORAGE_ACCOUNT="tfstate$(Build.BuildId)"
        az storage account create \
          --name $STORAGE_ACCOUNT \
          --resource-group TravelPlanner \
          --location "Central US" \
          --sku Standard_LRS \
          --encryption-services blob \
          --output none

        # Create storage container
        az storage container create \
          --name tfstate \
          --account-name $STORAGE_ACCOUNT \
          --output none

        # Set environment variable for storage account name
        echo "##vso[task.setvariable variable=storageAccountName]$STORAGE_ACCOUNT"

  - task: TerraformTaskV3@3
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: 'deployment'
      backendServiceArm: $(azureSubscription)
      backendAzureRmResourceGroupName: 'TravelPlanner'
      backendAzureRmStorageAccountName: $(storageAccountName)
      backendAzureRmContainerName: 'tfstate'
      backendAzureRmKey: 'terraform.tfstate'

  - task: TerraformTaskV3@3
    displayName: 'Terraform Validate'
    inputs:
      provider: 'azurerm'
      command: 'validate'
      workingDirectory: 'deployment'

  - task: TerraformTaskV3@3
    displayName: 'Terraform Plan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: $(azureSubscription)

  - task: TerraformTaskV3@3
    displayName: 'Terraform Apply'
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: 'deployment'
      environmentServiceNameAzureRM: $(azureSubscription)

  - task: AzureWebApp@1
    displayName: 'Deploy Azure Web App'
    inputs:
      azureSubscription: $(azureSubscription)
      appType: 'webAppLinux'
      appName: 'vintekh'
      package: '$(System.DefaultWorkingDirectory)/**'
      deploymentMethod: 'auto'